<!DOCTYPE html>
<html lang="en">
<head>  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ESP8266 Smart Relay Controller</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#2196F3">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Relay Control">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    /* Reset and base styles */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6fa;
      color: #222;
      min-height: 100vh;
    }
    .navbar {
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      padding: 0.75rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }
    .nav-content {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-size: 2rem;
      font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
      font-weight: 800;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #2563eb;
      text-shadow: 0 2px 8px rgba(37,99,235,0.08);
    }
    .logo .portal {
      font-family: 'Segoe UI', 'Arial', sans-serif;
      font-weight: 400;
      font-size: 1.1rem;
      margin-left: 0.4em;
      letter-spacing: 0.01em;
      color: #374151;
      text-shadow: none;
    }
    .connection-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 1rem;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.97rem;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      transition: background 0.2s;
    }
    .status-connected {
      background: #e6f9ed;
      color: #1a7f37;
      border-color: #b7e4c7;
    }
    .status-disconnected {
      background: #fbeaea;
      color: #b91c1c;
      border-color: #fca5a5;
    }
    .container {
      max-width: 1100px;
      margin: 2rem auto;
      padding: 0 1.5rem;
    }
    /* Bento grid layout */
    .bento-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
      align-items: stretch;
    }
    .bento-card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      border: 1px solid #e5e7eb;
      padding: 1.8rem 1.5rem 1.5rem 1.5rem;
      display: flex;
      flex-direction: column;
      min-height: 200px;
      opacity: 0;
      transform: translateY(30px);
      animation: fadeInUp 0.7s forwards;
      height: 100%;
    }
    .bento-card:nth-child(1) { animation-delay: 0.05s; }
    .bento-card:nth-child(2) { animation-delay: 0.15s; }
    .bento-card:nth-child(3) { animation-delay: 0.25s; }
    .bento-card:nth-child(4) { animation-delay: 0.35s; }
    .bento-card:hover {
      box-shadow: 0 6px 24px rgba(37,99,235,0.10);
      transform: translateY(-4px) scale(1.02);
      transition: box-shadow 0.2s, transform 0.2s;
    }
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .bento-title {
      font-size: 1.08rem;
      font-weight: 600;
      color: #2563eb;
      margin-bottom: 0.7rem;
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .bento-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      justify-content: center;
      padding: 0.5rem 0;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1rem;
      margin-bottom: 0.2em;
    }
    .info-label {
      color: #6b7280;
      font-size: 0.97em;
    }
    .info-value {
      font-weight: 500;
      color: #222;
      font-size: 1.05em;
    }
    .signal-strength {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      justify-content: flex-end;
    }
    .signal-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #d1d5db;
      display: inline-block;
    }
    .signal-dot.active {
      background: #1a7f37;
    }
    .relay-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 0.5rem; /* Add vertical spacing between rows */
      margin-top: 0.5rem;
    }
    .relay-table th, .relay-table td {
      padding: 0.5rem 0.3rem;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.97rem;
      background: #fff;
    }
    .relay-table th {
      background: #f3f4f6;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
    }
    .relay-table tr {
      transition: box-shadow 0.2s;
    }
    .relay-table tr:not(:first-child):hover {
      box-shadow: 0 2px 8px rgba(37,99,235,0.07);
      background: #f8fafc;
    }
    /* Two-column relay controls grid */
    .relay-controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.2rem;
      width: 100%;
      padding: 0.5rem 0;
    }
    .relay-controls-grid .relay-row-card {
      background: #f7fafc;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 1rem 1.2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      transition: all 0.2s ease-in-out;
    }
    .relay-row-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .relay-info {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .relay-description {
      font-size: 0.85rem;
      color: #6b7280;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .relay-status {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .relay-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .schedule-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      background: #e5e7eb;
      font-size: 0.75rem;
      color: #374151;
    }
    .schedule-badge i {
      font-size: 0.7rem;
    }
    body.dark-mode .schedule-badge {
      background: #374151;
      color: #e5e7eb;
    }
    .schedule-btn {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .schedule-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }
    body.dark-mode .schedule-btn:hover {
      background: #374151;
      color: #e7e7eb;
    }
    /* Toggle switch styles */
    .toggle-switch {
      width: 44px;
      height: 24px;
      background: #d1d5db;
      border-radius: 12px;
      position: relative;
      display: inline-block;
      cursor: pointer;
      transition: background 0.2s;
      vertical-align: middle;
      margin-left: 1em;
    }
    .toggle-switch::before {
      content: "";
      position: absolute;
      left: 3px;
      top: 3px;
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      transition: left 0.2s;
    }
    .toggle-switch.active {
      background: #2563eb;
    }
    .toggle-switch.active::before {
      left: 23px;
      background: #fff;
    }
    /* Relay ON/OFF status text color */
    .relay-status-on {
      color: #1a7f37;
      font-weight: bold;
    }
    .relay-status-off {
      color: #b91c1c;
      font-weight: bold;
    }
    .controls-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin: 0;
      align-items: stretch;
      width: 100%;
      padding: 0.5rem 0;
    }
    .control-btn {
      padding: 0.65rem 1.3rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.08rem;
      font-weight: 600;
      background: linear-gradient(90deg, #2563eb 60%, #60a5fa 100%);
      color: #fff;
      transition: background 0.18s, box-shadow 0.18s, transform 0.12s;
      box-shadow: 0 2px 8px rgba(37,99,235,0.10);
      outline: none;
      margin-bottom: 0;
      display: block;
      width: 100%;
      letter-spacing: 0.01em;
    }
    .control-btn:active, .control-btn:hover {
      background: linear-gradient(90deg, #1d4ed8 60%, #2563eb 100%);
      box-shadow: 0 4px 16px rgba(37,99,235,0.13);
      transform: translateY(-2px) scale(1.01);
    }
    .btn-danger {
      background: linear-gradient(90deg, #b91c1c 60%, #ef4444 100%);
      color: #fff;
    }
    .btn-danger:active, .btn-danger:hover {
      background: linear-gradient(90deg, #991b1b 60%, #b91c1c 100%);
      box-shadow: 0 4px 16px rgba(185,28,28,0.13);
    }
    @media (max-width: 1200px) {
      .bento-grid { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
    }
    @media (max-width: 900px) {
      /* Responsive Layout Improvements */
      .container { 
        padding: 0.8rem;
        margin: 1rem auto;
        max-width: 100%;
      }
      .nav-content {
        padding: 0 1rem;
      }
      .bento-grid { 
        grid-template-columns: 1fr !important;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      .relay-controls-row { 
        grid-template-columns: 1fr !important;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      .relay-controls-grid {
        grid-template-columns: 1fr;
        gap: 0.8rem;
      }
      .relay-row-card {
        padding: 1rem 0.8rem;
      }
      .controls-section {
        gap: 0.6rem;
      }
      .control-btn {
        padding: 0.9rem 0.8rem;
      }
    }
    /* Remove these overrides since we're handling them above */
    @media (max-width: 700px) {
      .bento-grid { grid-template-columns: 1fr; }
      .relay-controls-row { grid-template-columns: 1fr; gap: 1.2rem; }
      .relay-controls-grid { grid-template-columns: 1fr; gap: 1rem; }
    }
    @media (max-width: 600px) {
      .container {
        padding: 0.5rem;
      }
      .nav-content {
        padding: 0 0.8rem;
      }
      .logo {
        font-size: 1.5rem;
      }
      .logo .portal {
        font-size: 0.9rem;
      }
      .connection-status {
        padding: 0.3rem 0.8rem;
        font-size: 0.9rem;
      }
      #themeToggleBtn {
        font-size: 1.2em;
        margin-right: 0.5em;
      }
      .relay-row-card {
        padding: 1rem 0.8rem;
      }
      .controls-section {
        gap: 0.6rem;
      }
      .control-btn {
        padding: 0.9rem 0.8rem;
      }
    }
    /* New: relay-controls-row for relay+buttons in same row */
    .relay-controls-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
      align-items: start;
      width: 100%;
    }
    .controls-card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      border: 1px solid #e5e7eb;
      padding: 1.8rem 1.5rem 1.5rem 1.5rem;
      display: flex;
      flex-direction: column;
      min-height: 200px;
      opacity: 0;
      transform: translateY(30px);
      animation: fadeInUp 0.7s forwards;
      animation-delay: 0.45s;
      justify-content: center;
      align-items: center;
      margin-bottom: 0;
      height: 100%;
      /* Card effect matches .bento-card */
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .controls-card:hover {
      box-shadow: 0 6px 24px rgba(37,99,235,0.10);
      transform: translateY(-4px) scale(1.02);
    }
    /* Improved Schedule Dialog Styles */
    dialog {
      padding: 1.5rem;
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      max-width: 500px;
      width: 95%;
      background: #fff;
    }

    .schedule-dialog-content {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .schedule-dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .schedule-dialog-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #2563eb;
    }

    .schedule-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      max-height: 300px;
      overflow-y: auto;
    }

    .schedule-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      gap: 1rem;
    }

    .schedule-item-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .schedule-time {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1e293b;
    }

    .schedule-days {
      font-size: 0.9rem;
      color: #64748b;
    }

    .schedule-action {
      font-weight: 500;
    }

    .schedule-item-actions {
      display: flex;
      gap: 0.5rem;
    }

    .days-selector {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
      margin: 0.5rem 0;
    }

    .day-checkbox {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
    }

    .day-label {
      font-size: 0.8rem;
      color: #64748b;
      text-align: center;
    }

    .schedule-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-group label {
      font-size: 0.9rem;
      font-weight: 500;
      color: #374151;
    }

    .form-group input[type="time"],
    .form-group select {
      padding: 0.5rem;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 1rem;
    }

    .dialog-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .dialog-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
    }

    /* Dark mode support */
    body.dark-mode dialog {
      background: #23262f;
      color: #e5e7eb;
    }

    body.dark-mode .schedule-item {
      background: #1e1e2d;
      border-color: #334155;
    }

    body.dark-mode .schedule-time {
      color: #e5e7eb;
    }

    body.dark-mode .schedule-days {
      color: #94a3b8;
    }

    body.dark-mode .form-group label {
      color: #e5e7eb;
    }

    body.dark-mode .form-group input[type="time"],
    body.dark-mode .form-group select {
      background: #1e1e2d;
      border-color: #334155;
      color: #e7e7eb;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-content">
      <div class="logo">
        <i class="fas fa-bolt"></i>
        Home Controller <span class="portal">Web Portal</span>
      </div>
      <button id="themeToggleBtn" title="Toggle light/dark mode" style="background:none;border:none;cursor:pointer;font-size:1.4em;margin-right:1em;">
        <i id="themeToggleIcon" class="fas fa-moon"></i>
      </button>
      <div id="connectionStatus" class="connection-status status-disconnected">
        <span>Connecting...</span>
      </div>
    </div>
  </nav>
  <div class="container">
    <div class="bento-grid">
      <!-- Device Info Card -->
      <div class="bento-card">
        <div class="bento-title"><i class="fas fa-microchip"></i> Device Info</div>
        <div class="bento-content">
          <div class="info-row"><span class="info-label">Chip ID</span><span class="info-value" id="chipId">-</span></div>
          <div class="info-row"><span class="info-label">Free RAM</span><span class="info-value" id="freeHeap">-</span></div>
          <div class="info-row"><span class="info-label">Uptime</span><span class="info-value" id="uptime">-</span></div>
          <div class="info-row"><span class="info-label">Reset Reason</span><span class="info-value" id="resetReason">-</span></div>
        </div>
      </div>
      <!-- Network Card -->
      <div class="bento-card">
        <div class="bento-title"><i class="fas fa-wifi"></i> Network</div>
        <div class="bento-content">
          <div class="info-row"><span class="info-label">SSID</span><span class="info-value" id="ssid">-</span></div>
          <div class="info-row"><span class="info-label">IP Address</span><span class="info-value" id="ipAddress">-</span></div>
          <div class="info-row"><span class="info-label">MAC Address</span><span class="info-value" id="macAddress">-</span></div>
          <div class="info-row">
            <span class="info-label">Signal</span>
            <span class="info-value">
              <span class="signal-strength" id="signalStrength">
                <span class="signal-dot" id="sig1"></span>
                <span class="signal-dot" id="sig2"></span>
                <span class="signal-dot" id="sig3"></span>
                <span class="signal-dot" id="sig4"></span>
                <span id="rssi" style="margin-left:0.5em;">-</span>
              </span>
            </span>
          </div>
        </div>
      </div>
      <!-- System Card -->
      <div class="bento-card">
        <div class="bento-title"><i class="fas fa-server"></i> System</div>
        <div class="bento-content">
          <div class="info-row"><span class="info-label">WS Clients</span><span class="info-value" id="wsClients">-</span></div>
          <div class="info-row"><span class="info-label">Active Relays</span><span class="info-value" id="activeRelays">-</span></div>
          <div class="info-row"><span class="info-label">Total Switches</span><span class="info-value" id="totalSwitches">-</span></div>
          <div class="info-row"><span class="info-label">Last Update</span><span class="info-value" id="lastUpdate">-</span></div>
        </div>
      </div>
    </div>
    <!-- Relay Controls and Controls Card in the same row -->
    <div class="relay-controls-row">
      <div class="bento-card">
        <div class="bento-title"><i class="fas fa-toggle-on"></i> Relay Controls</div>
        <div class="bento-content">
          <div class="relay-controls-grid" id="relayControlsGrid">
            <!-- Relay controls will be populated here -->
          </div>
        </div>
      </div>
      <div class="controls-card">
        <div class="bento-title"><i class="fas fa-cogs"></i> Actions</div>
        <div class="controls-section">
          <button class="control-btn" onclick="refreshStatus()">
            Refresh Status
          </button>
          <button class="control-btn btn-danger" onclick="resetDevice()">
            Reset Device
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Add scheduling dialog -->
  <dialog id="scheduleDialog">
    <div class="schedule-dialog-content">
      <div class="schedule-dialog-header">
        <div class="schedule-dialog-title">Relay Schedule</div>
        <button class="btn-close" onclick="closeScheduleDialog()" style="background:none;border:none;cursor:pointer;font-size:1.2em;color:#64748b;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="schedulesList" class="schedule-list"></div>
      <form id="scheduleForm" class="schedule-form">
        <div class="form-group">
          <label>Time:</label>
          <input type="time" id="scheduleTime" required>
        </div>
        <div class="form-group">
          <label>Days:</label>
          <div class="days-selector">
            <label class="day-checkbox"><input type="checkbox" value="0">Sun<span class="day-label">S</span></label>
            <label class="day-checkbox"><input type="checkbox" value="1">Mon<span class="day-label">M</span></label>
            <label class="day-checkbox"><input type="checkbox" value="2">Tue<span class="day-label">T</span></label>
            <label class="day-checkbox"><input type="checkbox" value="3">Wed<span class="day-label">W</span></label>
            <label class="day-checkbox"><input type="checkbox" value="4">Thu<span class="day-label">T</span></label>
            <label class="day-checkbox"><input type="checkbox" value="5">Fri<span class="day-label">F</span></label>
            <label class="day-checkbox"><input type="checkbox" value="6">Sat<span class="day-label">S</span></label>
          </div>
        </div>
        <div class="form-group">
          <label>Action:</label>
          <select id="scheduleAction">
            <option value="true">Turn ON</option>
            <option value="false">Turn OFF</option>
          </select>
        </div>
        <div class="dialog-buttons">
          <button type="submit" class="dialog-btn btn-primary">Save Schedule</button>
          <button type="button" class="dialog-btn btn-secondary" onclick="closeScheduleDialog()">Cancel</button>
        </div>
      </form>
    </div>
  </dialog>
<script>
let websocket = null;
let connected = false;
let deviceData = {};
let switchCount = 0;
let currentSchedules = [];
let currentRelayId = null;

function updateConnectionStatus(isConnected) {
  const statusEl = document.getElementById('connectionStatus');
  connected = isConnected;
  if (isConnected) {
    statusEl.className = 'connection-status status-connected';
    statusEl.innerHTML = '<span>Connected</span>';
  } else {
    statusEl.className = 'connection-status status-disconnected';
    statusEl.innerHTML = '<span>Disconnected</span>';
  }
}

function formatBytes(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function formatUptime(milliseconds) {
  const seconds = Math.floor(milliseconds / 1000);
  const days = Math.floor(seconds / 86400);
  const hours = Math.floor((seconds % 86400) / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  if (days > 0) return `${days}d ${hours}h`;
  if (hours > 0) return `${hours}h ${minutes}m`;
  return `${minutes}m`;
}

function updateSignalStrength(rssi) {
  // rssi: 0 (bad) to -100 (worst)
  let level = 0;
  if (rssi >= -50) level = 4;
  else if (rssi >= -60) level = 3;
  else if (rssi >= -70) level = 2;
  else if (rssi >= -80) level = 1;
  else level = 0;
  for (let i = 1; i <= 4; i++) {
    document.getElementById('sig'+i).className = 'signal-dot' + (i <= level ? ' active' : '');
  }
}

function updateDeviceInfo(data) {
  if (data.device) {
    document.getElementById('chipId').textContent = data.device.chipId || '-';
    document.getElementById('freeHeap').textContent = formatBytes(data.device.freeHeap || 0);
    document.getElementById('uptime').textContent = formatUptime(data.device.uptime || 0);
    document.getElementById('resetReason').textContent = data.device.resetReason || '-';
  }
  if (data.wifi) {
    document.getElementById('ssid').textContent = data.wifi.ssid || '-';
    document.getElementById('ipAddress').textContent = data.wifi.ip || '-';
    document.getElementById('macAddress').textContent = data.wifi.mac || '-';
    const rssi = data.wifi.rssi || -100;
    document.getElementById('rssi').textContent = `${rssi} dBm`;
    updateSignalStrength(rssi);
  }
  if (data.websocket) {
    document.getElementById('wsClients').textContent = data.websocket.clients || '0';
  }
  if (data.relays) {
    const activeRelays = Object.values(data.relays).filter(state => state).length;
    document.getElementById('activeRelays').textContent = activeRelays;
    document.getElementById('totalSwitches').textContent = switchCount;
  }
  document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
}

function createRelayControlCard(index, data) {
  const state = data.state || false;
  const name = data.name || `Relay ${index + 1}`;
  const description = data.description || '';
  const scheduled = data.scheduled || false;
  const scheduleCount = data.numSchedules || 0;
  
  return `
    <div class="relay-row-card">
      <div class="relay-info">
        <span class="relay-row-label">${name}</span>
        ${description ? `<span class="relay-description">${description}</span>` : ''}
      </div>
      <div class="relay-status">
        <span class="${state ? 'relay-status-on' : 'relay-status-off'}">${state ? 'ON' : 'OFF'}</span>
        ${scheduled ? `<span class="schedule-badge" title="${scheduleCount} schedule(s) active"><i class="fas fa-clock"></i>${scheduleCount}</span>` : ''}
      </div>
      <div class="relay-actions">
        <button class="schedule-btn" onclick="showScheduleDialog(${index})">
          <i class="fas fa-calendar-alt"></i>
        </button>
        <span class="toggle-switch${state ? ' active' : ''}" onclick="toggleRelay(${index})" title="Toggle Relay"></span>
      </div>
    </div>
  `;
}

function updateRelayControls(relayData) {
  const container = document.getElementById('relayControlsGrid');
  let html = '';
  
  // Handle both old and new API formats
  if (Array.isArray(relayData)) {
    for (let i = 0; i < relayData.length; i++) {
      html += createRelayControlCard(i, relayData[i]);
    }
  } else if (typeof relayData === 'object') {
    for (let i = 0; i < 4; i++) {
      const relay = relayData[i] || { state: false };
      html += createRelayControlCard(i, relay);
    }
  }
  
  container.innerHTML = html;
  
  // Update system info
  const activeCount = Object.values(relayData).filter(r => r.state).length;
  document.getElementById('activeRelays').textContent = activeCount;
}

function toggleRelay(index) {
  const relay = deviceData.relays && deviceData.relays[index];
  const currentState = relay ? relay.state : false;
  const newState = !currentState;
  
  // Optimistic UI update
  if (!deviceData.relays) deviceData.relays = {};
  if (!deviceData.relays[index]) deviceData.relays[index] = {};
  deviceData.relays[index].state = newState;
  updateRelayControls(deviceData.relays);
  switchCount++;
  
  // Send command via WebSocket for faster response
  if (websocket && websocket.readyState === WebSocket.OPEN) {
    websocket.send(JSON.stringify({
      cmd: 'set',
      relay: index,
      state: newState
    }));
  } else {
    // Fallback to HTTP if WebSocket is not available
    fetch("/api/relay", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        relay: index,
        state: newState
      })
    })
    .then(response => {
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return response.json();
    })
    .then(data => {
      if (!data.success) {
        throw new Error(data.error || 'Failed to toggle relay');
      }
    })
    .catch(err => {
      deviceData.relays[index].state = currentState;
      updateRelayControls(deviceData.relays);
      showError("Failed to toggle relay: " + err.message);
    });
  }
}

function refreshStatus() {
  fetch("/api/status")
    .then(res => res.json())
    .then(data => {
      deviceData = data;
      updateDeviceInfo(data);
      updateRelayControls(data.relays);
      if (!connected) updateConnectionStatus(true);
    })
    .catch(err => {
      updateConnectionStatus(false);
    });
}

function resetDevice() {
  if (confirm("Are you sure you want to reset the device? This will restart the ESP8266 and clear WiFi settings.")) {
    fetch("/reset")
      .then(() => {
        alert("Device is resetting. You may need to reconnect to the WiFi network.");
        setTimeout(() => location.reload(), 3000);
      })
      .catch(err => {});
  }
}

function setupWebSocket() {
  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${protocol}//${location.host}/ws`;
  websocket = new WebSocket(wsUrl);
  websocket.onopen = function() {
    updateConnectionStatus(true);
  };
  websocket.onmessage = function(event) {
    try {
      const data = JSON.parse(event.data);
      if (!deviceData.relays) deviceData.relays = {};
      Object.assign(deviceData.relays, data);
      updateRelayControls(deviceData.relays);
      updateDeviceInfo(deviceData);
    } catch (err) {}
  };
  websocket.onclose = function() {
    updateConnectionStatus(false);
    setTimeout(setupWebSocket, 3000);
  };
  websocket.onerror = function(error) {
    updateConnectionStatus(false);
  };
}

document.addEventListener('DOMContentLoaded', function() {
  updateConnectionStatus(false);
  refreshStatus();
  setupWebSocket();
  setInterval(refreshStatus, 30000);
  // Theme setup
  const savedTheme = localStorage.getItem('theme');
  setTheme(savedTheme === 'dark');
  document.getElementById('themeToggleBtn').onclick = toggleTheme;
});

// Theme toggle logic
function setTheme(dark) {
  if (dark) {
    document.body.classList.add('dark-mode');
    document.getElementById('themeToggleIcon').className = 'fas fa-sun';
    localStorage.setItem('theme', 'dark');
  } else {
    document.body.classList.remove('dark-mode');
    document.getElementById('themeToggleIcon').className = 'fas fa-moon';
    localStorage.setItem('theme', 'light');
  }
}
function toggleTheme() {
  setTheme(!document.body.classList.contains('dark-mode'));
}

// Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('ServiceWorker registration successful');
        requestNotificationPermission();
      })
      .catch(error => {
        console.log('ServiceWorker registration failed:', error);
      });
  });
}

// Notification Permission Request
function requestNotificationPermission() {
  if ('Notification' in window) {
    Notification.requestPermission()
      .then(permission => {
        if (permission === 'granted') {
          console.log('Notification permission granted');
        }
      });
  }
}

// Schedule Management
function showScheduleDialog(relayId) {
  currentRelayId = relayId;
  const dialog = document.getElementById('scheduleDialog');
  const relayName = deviceData.relays[relayId].name || `Relay ${relayId + 1}`;
  
  // Update dialog title
  document.querySelector('.schedule-dialog-title').textContent = `${relayName} Schedules`;
  
  fetch(`/api/schedules?relay=${relayId}`)
    .then(response => response.json())
    .then(data => {
      currentSchedules = data.schedules || [];
      displaySchedules(data);
      dialog.showModal();
    })
    .catch(error => {
      console.error('Error fetching schedules:', error);
      dialog.showModal();
    });
}

function closeScheduleDialog() {
  document.getElementById('scheduleDialog').close();
}

function formatTime(hour, minute) {
  return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
}

function formatDays(days) {
  const dayNames = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
  return days.map((enabled, i) => enabled ? dayNames[i] : '').filter(d => d).join(' ');
}

function displaySchedules(data) {
  const container = document.getElementById('schedulesList');
  const schedules = data.schedules || [];
  
  if (schedules.length === 0) {
    container.innerHTML = '<p class="text-gray-500">No schedules set</p>';
    return;
  }

  const html = schedules.map((schedule, index) => `
    <div class="schedule-item">
      <div class="schedule-item-info">
        <div class="schedule-time">${formatTime(schedule.hour, schedule.minute)}</div>
        <div class="schedule-days">${formatDays(schedule.days)}</div>
      </div>
      <div class="schedule-action ${schedule.state ? 'relay-status-on' : 'relay-status-off'}">
        ${schedule.state ? 'ON' : 'OFF'}
      </div>
      <div class="schedule-item-actions">
        <button class="schedule-btn" onclick="toggleScheduleEnabled(${index})" title="${schedule.enabled ? 'Disable' : 'Enable'} schedule">
          <i class="fas fa-${schedule.enabled ? 'check-circle' : 'times-circle'}"></i>
        </button>
        <button class="schedule-btn" onclick="deleteSchedule(${index})" title="Delete schedule">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  `).join('');

  container.innerHTML = html;
}

function toggleScheduleEnabled(index) {
  if (!currentSchedules[index]) return;
  
  currentSchedules[index].enabled = !currentSchedules[index].enabled;
  
  saveSchedules()
    .then(() => displaySchedules({ schedules: currentSchedules }))
    .catch(error => console.error('Error toggling schedule:', error));
}

function deleteSchedule(index) {
  if (!confirm('Are you sure you want to delete this schedule?')) return;
  
  currentSchedules.splice(index, 1);
  
  saveSchedules()
    .then(() => displaySchedules({ schedules: currentSchedules }))
    .catch(error => {
      console.error('Error deleting schedule:', error);
      currentSchedules.splice(index, 0, savedSchedule);
    });
}

function saveSchedules() {
  const scheduleData = {
    relay: currentRelayId,
    scheduled: currentSchedules.length > 0,
    schedules: currentSchedules
  };

  return fetch('/api/schedules', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(scheduleData)
  }).then(response => {
    if (!response.ok) {
      throw new Error('Failed to save schedules');
    }
  });
}

document.getElementById('scheduleForm').addEventListener('submit', (e) => {
  e.preventDefault();
  
  const time = document.getElementById('scheduleTime').value;
  const [hours, minutes] = time.split(':').map(Number);
  const days = Array.from(document.querySelectorAll('.days-selector input'))
    .map(input => input.checked);
  const state = document.getElementById('scheduleAction').value === 'true';

  const newSchedule = {
    hour: hours,
    minute: minutes,
    days,
    state,
    enabled: true
  };

  const savedSchedule = {...newSchedule};
  currentSchedules.push(newSchedule);

  saveSchedules()
    .then(() => {
      displaySchedules({ schedules: currentSchedules });
      e.target.reset();
    })
    .catch(error => {
      console.error('Error saving schedule:', error);
      currentSchedules.pop(); // Remove the schedule if save failed
    });
});
  </script>
</body>
</html>
